# ADR-001: 金額スケールの統一

- Status: Updated
- Date: 2025-10-29 JST
- Decision Drivers
  - 金額比較やテスト期待値の**一貫性を保つ**
  - 外部API・UIでの**表現統一（小数桁の混乱防止）**
  - **丸め誤差の切り分け**を明確にする（税計算とそれ以外を区別）
  - **再計算やログ比較が容易**になる
  - ドメインモデルの**シンプルさと説明可能性**を優先

## Context
- 注文集計や将来の Stream 集計課題と統合する際、BigDecimal のスケール差が合算結果や equals 判定に影響し、予期せぬ不一致が発生する。
- 割引適用時は小数が出る一方、非適用時は整数になるなど、現状はスケールが揺れる。
- 表示や集計の安定性、テスト容易性のため、スケール規約を“設計として固定”したい。
- 評価観点：
  - 正確性・再現性（丸め規約の固定による環境非依存性）
  - 一貫性・可読性（DTO/APIの桁数固定）
  - テスト容易性（境界・丸めテストの明確化）
  - 可観測性・監査可能性（税由来の端数とそれ以外の切り分け）
  - 後方互換性（OpenAPIでの表現固定による互換維持）
  - 保守性・拡張性（多通貨時にMoney型へ移行可能）
  - パフォーマンス・実装コスト（`setScale`の最終境界適用で過剰処理を避ける）

## Decision
- OrderResult の各金額フィールドのスケールを以下に固定する。
  - totalNet: scale=2
  - totalDiscount: scale=2
  - totalNetAfterDiscount: scale=2  ← 追加(2025/10/29)
  - totalTax: scale=2（丸め前税額の表現は2桁保持とする）
  - totalGross: scale=0（丸め済み税込合計。外部の丸め規則に従うが格納時は0桁に正規化）
- OrderResult 生成（公開境界）で必ず setScale により規格化（normalize）し、以降は変更しない。
- 集計系（ユーザ×期間など）の合算前に、全レコードがこの規格に合致していることを前提とし、必要に応じて前処理で正規化を行う。
- ゼロ値も規定スケールのゼロを使用（0→Gross、0.00→Net/Discount/Tax）。

## Consequences
- 影響範囲
  - 実装: OrderResult ビルド直前でスケール正規化を追加する。totalNetのみは税計算のズレを防ぐため税計算前にスケールを正規化。
  - テスト: equals（スケール含む）での比較に統一し、期待値は "1000.00"／"113663" のように規定スケールで用意する。
  - 既存データ: 既存の結果を集計にかける場合、移行前処理で正規化が必要。
  - ドキュメント: 金額フィールドのスケール仕様を API/設計書に明記。

## Alternatives Considered
- 数値比較のみ（compareTo）でスケール不問にする → 集計や equals ベースの比較で再び揺れるため却下。
- すべて 2 桁に統一 → Gross はビジネス的に整数表示が多く、表示・仕様の整合性に劣る。

## Notes
- テスト戦略
  - スケール検証: value.scale() が規定値であることを各フィールドで確認。(Normal)
  - 代表値検証: 割引あり／なし・閾値境界で Net/Discount/Tax の 2 桁保持と Gross の 0 桁保持を確認。(Normal)、(Threshold)
  - 集計検証(StreamAPI実装結合後): ユーザ×期間集計でスケールが崩れないことを確認（初期値スケールも含めて）。
- リスクとフォロー
  - 外部から取り込む過去データのスケール混在 → 取り込み時に正規化レイヤを通す。
  - 他システムとのインターフェース差異 → 受入／送出のアダプタでスケール変換を実施。
